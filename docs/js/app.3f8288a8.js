(function(){"use strict";var e={921:function(e,t,n){var o=n(7195),s=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("div",{staticStyle:{position:"absolute",width:"100%",left:"0","font-size":"20px","font-weight":"bold",padding:"10px",top:"0","background-color":"aqua"}},[e._v("webRTC 功能演示")]),t("h1",[t("span",{staticStyle:{color:"#999"}},[e._v("用户：")]),e._v(e._s(e.peer))]),t("div",{staticStyle:{"text-align":"center"}},[t("img",{attrs:{height:"200",alt:"Vue logo",src:e.imgSrc},on:{click:e.resetImage}})]),t("div",{staticStyle:{display:"flex"}},[t("div",[t("button",{staticStyle:{width:"80px"},on:{click:e.pullText}},[e._v("拉取文本")]),e._v("  "),t("button",{staticStyle:{width:"80px"},on:{click:e.pullImage}},[e._v("拉取图片")])])]),t("div",{staticStyle:{"text-align":"left"}},[t("pre",[e._v(e._s(e.logs))])])])},r=[],c=(n(6229),n(7330),n(2062),{name:"App",data(){return{imgSrc:"./logo1.png",peer:new URLSearchParams(location.search).get("peer"),logs:""}},methods:{resetImage(){this.imgSrc="./logo1.png"},pullImage(){this.imgSrc="./logo2.png"},pullText(){fetch("./text.js").then((e=>e.json())).then((({text:e})=>{this.logs+=`${(new Date).toLocaleString()} ${e}\n`}))}}}),a=c,i=n(1001),l=(0,i.Z)(a,s,r,!1,null,null,null),d=l.exports;n(7658);class h extends EventTarget{constructor(e,t){super(),this.peers=e,this.connections=[],this.signaling=t,this.$connections=this.connections,this.listenSignaling(),e.forEach((async e=>{await this.join(e)}))}async sendOffer(e){const{signaling:t}=this,n=await e.createOffer();try{e.setLocalDescription(n),t.send({type:"offer",data:n},e.peer),console.log("【MultiRPC】发送offer",n)}catch(o){console.log("【MultiRPC】发送offer失败",o)}}listenSignaling(){const{signaling:e,connections:t,join:n}=this;e.addEventListener("message",(async({detail:{from:o,content:{type:s,data:r}}})=>{let c=t.find((e=>e.peer===o));switch(c||(console.log("【MultiRPC】未找到匹配的 connection, 重新创建"),c=await n.call(this,o,!0),this.dispatchEvent(new CustomEvent("new",{detail:c}))),s){case"offer":console.log("【MultiRPC】收到offer",r);try{await c.setRemoteDescription(r);const t=await c.createAnswer();e.send({type:"answer",data:t},o),console.log("【MultiRPC】发送answer",t),c.setLocalDescription(t)}catch(a){console.log("【MultiRPC】收到 offer 后执行异常",a)}break;case"answer":console.log("【MultiRPC】收到 answer",r);try{c.setRemoteDescription(r),c.addEventListener("datachannel",(()=>{console.warn("对方建立datachannel",c)}))}catch(i){console.log("【MultiRPC】setRemoteDescription 失败",i)}break;case"candidate":console.log("【MultiRPC】收到 candidate",r),c.addIceCandidate(r);break}}))}listenConnection(e){const{signaling:t}=this;e.addEventListener("icecandidate",(({candidate:n})=>{n&&t.send({type:"candidate",data:n},e.peer)})),e.addEventListener("negotiationneeded",(async()=>{console.log("【MultiRPC】negotiationneeded"),this.sendOffer(e)})),e.addEventListener("connectionstatechange",(async t=>{const n={connected:"建立",disconnected:"断开",connecting:"中"};console.log(`【MultiRPC】与用户${e.peer}对等连接${n[e.connectionState]||e.connectionState}！`,t)}))}async join(e,t){const{connections:n}=this,o=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]});return console.log("【MultiRPC】创建 RTCPeerConnection",e),this.listenConnection(o),o.peer=e,t||this.sendOffer(o),n.push(o),o}}const g=e=>Object.prototype.toString.call(e).slice(8,-1),u=async e=>{let t=e;"Blob"===g(e)&&(t=await e.text());let n={};try{n=JSON.parse(t)}catch(o){console.error(o)}return n},f="signaling",p=async e=>{const{data:t}=e,n=await u(t),{cmd:o,from:s,data:r={}}=n,{type:c,content:a}=r;if("send"===o&&c===f)return{content:a,from:s}};class v extends EventTarget{constructor(e){super(),this.socket=e;const t=1,n=3;if(e.readyState===t){const e=new CustomEvent("open");this.dispatchEvent(e)}if(e.readyState===n){const e=new CustomEvent("close");this.dispatchEvent(e)}this.socket.addEventListener("open",(e=>{const t=new CustomEvent("open",e);this.dispatchEvent(t)})),this.socket.addEventListener("close",(e=>{const t=new CustomEvent("close",e);this.dispatchEvent(t)})),this.socket.addEventListener("message",(async e=>{const t=await p(e);if(!t)return;const n=new CustomEvent("message",{detail:t});this.dispatchEvent(n)}))}send(e,t){this.socket.send(JSON.stringify({cmd:"send",data:{type:f,content:e},to:t?[t]:[]}))}}n(1439),n(7585),n(5315);const w=16,y=4,m=e=>{const t={};return e.headers.forEach(((e,n)=>{t[n]=e})),t},E=e=>{try{return(new TextEncoder).encode(JSON.stringify(e))}catch{}},S=e=>{try{return JSON.parse((new TextDecoder).decode(e))}catch{}},C=(e,t)=>{const n=new Uint8Array(t);for(let o=0;o<t;o++){const s=8*(t-o-1),r=255<<s;n[o]=(e&r)>>>s}return n},b=e=>{let t=0;for(let n=0;n<e.length;n++){const o=8*(e.length-n-1);t|=e[n]<<o}return t},L=async(e,t)=>{const n=await e.arrayBuffer(),o=new Uint8Array(t.split(",")),s=E(m(e));if(s.byteLength>Math.pow(2,8*y))return;const r=C(s.byteLength,4),c=new Uint8Array(n),a=new Uint8Array(w+y+s.byteLength+n.byteLength);return a.set(o),a.set(r,w),a.set(s,w+y),a.set(c,w+y+s.byteLength),a},k=async e=>{const t=new Uint8Array(e),n=t.slice(0,w).toString(),o=b(t.slice(w,w+y)),s=S(t.slice(w+y,w+y+o));console.log(s);const r=t.slice(w+y+o);return console.log(r,"123"),{id:n,headers:s,response:r}},x=(e=16)=>Array.from(new Array(e),(()=>Math.floor(256*Math.random()))).join(),O=new URLSearchParams(location.search).get("peer"),R=`wss://service-h4z7zdeo-1258344701.gz.apigw.tencentcs.com?room=ola&peer=${O}`,P=new WebSocket(R),M=new v(P),T={},_=1e4;let j,A=3;const D=(e,t)=>{e.channel?.send(t)},J=(e,t)=>(e.channel=t||e.createDataChannel("resource"),e.channel.addEventListener("error",(({error:t})=>{console.log("【channel】datachannel异常",t),!t.errorDetail&&A-- >0&&(J(e),setTimeout((()=>{A=3}),_))})),e.channel.addEventListener("message",(async({data:t})=>{if("string"===typeof t){const{cmd:n,data:o}=JSON.parse(t);if(console.log("【channel】",n,o),"fetch"===n){const{url:t,id:n}=o;let s=await caches.match(t,{ignoreSearch:!0});if(console.log("【channel】response",s),s){const t=await L(s,n);D(e,t)}}}if(t instanceof ArrayBuffer){const{id:e,headers:n,response:o}=await k(t);console.log(e,n,o),T[e]?.call(void 0,{headers:n,response:o})}})),e.channel),N=e=>{e.addEventListener("datachannel",(({channel:t})=>{console.log("【channel】对方建立channel"),J(e,t)}))};P.addEventListener("open",(()=>{P.addEventListener("message",(({data:e})=>{const{data:t,cmd:n}=JSON.parse(e);if("peers"===n){const e=t.filter((e=>e!==O)),n=new h(e,M);window.$multiRTCPeerConnection=n,j=n.connections,j.forEach((e=>{N(e),J(e)})),n.addEventListener("new",(({detail:e})=>{N(e)}))}})),P.send(JSON.stringify({cmd:"peers"}))}));const $=(e,t=x(w))=>new Promise((n=>{j?.forEach((o=>{if(!o.channel)return void console.warn("【fetchRTC】没有 channel");const s=()=>{D(o,JSON.stringify({data:{url:e,id:t},cmd:"fetch"}))};"open"===o.channel.readyState?s():o.channel.onopen=()=>{s()},T[t]=n}))}));var U=$;const W=()=>{"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.addEventListener("message",(({data:e})=>{console.log("【fetchRTC】发起",e);const{url:t,id:n}=e;console.log("id",n),U(t,n).then((({headers:e,response:t})=>{console.log("【fetchRTC】响应",e,t),navigator.serviceWorker.controller.postMessage({id:n,headers:e,response:t})}))})),navigator.serviceWorker.register("/sw.js").then((e=>{console.log("SW registered: ",e)})).catch((e=>{console.log("SW registration failed: ",e)}))}))};W(),o.ZP.config.productionTip=!1,new o.ZP({render:e=>e(d)}).$mount("#app")}},t={};function n(o){var s=t[o];if(void 0!==s)return s.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,n),r.exports}n.m=e,function(){var e=[];n.O=function(t,o,s,r){if(!o){var c=1/0;for(d=0;d<e.length;d++){o=e[d][0],s=e[d][1],r=e[d][2];for(var a=!0,i=0;i<o.length;i++)(!1&r||c>=r)&&Object.keys(n.O).every((function(e){return n.O[e](o[i])}))?o.splice(i--,1):(a=!1,r<c&&(c=r));if(a){e.splice(d--,1);var l=s();void 0!==l&&(t=l)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[o,s,r]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={143:0};n.O.j=function(t){return 0===e[t]};var t=function(t,o){var s,r,c=o[0],a=o[1],i=o[2],l=0;if(c.some((function(t){return 0!==e[t]}))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);if(i)var d=i(n)}for(t&&t(o);l<c.length;l++)r=c[l],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return n.O(d)},o=self["webpackChunkrtc_workbox"]=self["webpackChunkrtc_workbox"]||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))}();var o=n.O(void 0,[998],(function(){return n(921)}));o=n.O(o)})();
//# sourceMappingURL=app.3f8288a8.js.map