(function(){"use strict";var e={4372:function(e,t,n){var r=n(7195),o=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("h1",[t("span",{staticStyle:{color:"#999"}},[e._v("用户：")]),e._v(e._s(e.peer))]),t("div",{staticStyle:{"text-align":"center"}},[t("img",{ref:"img",attrs:{height:"200",alt:"Vue logo",src:e.imgSrc},on:{click:e.resetImage}})]),t("div",{staticStyle:{display:"flex"}},[t("div",[t("button",{staticStyle:{width:"80px"},on:{click:e.pullText}},[e._v("拉取文本")]),e._v("  "),t("button",{staticStyle:{width:"80px"},on:{click:e.pullImage}},[e._v("拉取图片")]),e._v("  "),t("button",{staticStyle:{width:"80px"},on:{click:function(t){e.showHelloWorld=!0}}},[e._v("拉取脚本")]),e._v("  ")])]),t("ul",{staticStyle:{"text-align":"left"}},e._l(e.logs,(function({date:n,content:r},o){return t("li",{key:o},[e._v(" "+e._s(n)+" "),t("b",[e._v(e._s(r))])])})),0),e.showHelloWorld?t("HelloWorld"):e._e()],1)},i=[],s=(n(6229),n(7330),n(2062),n(7658),{components:{HelloWorld:()=>n.e(173).then(n.bind(n,1173))},name:"App",data(){return{imgSrc:"./logo.png",peer:new URLSearchParams(location.search).get("peer"),logs:[],showHelloWorld:!1}},methods:{resetImage(){this.imgSrc="./logo.png"},pullImage(){this.imgSrc="./img.png",this.$refs.img.onload=function(e){console.log(e)}},async pullText(){const e=await fetch("./text.js"),{text:t}=await e.json();this.logs.push({date:(new Date).toLocaleString(),content:t})}}}),a=s,c=n(1001),l=(0,c.Z)(a,o,i,!1,null,null,null),d=l.exports,u=n(6318);const h={Log:0,Warning:1,Error:2};class f{constructor(e){this.namespace=e}log(e,t){}setNamespace(e){return this.namespace=e,this}create(e){return new f(e)}info(...e){return this.log(h.Log,e),this}warn(...e){return this.log(h.Warning,e),this}error(...e){return this.log(h.Error,e),this}}const p=new f("【MRPC】");class g extends EventTarget{constructor(e,t){super(),this.peers=e,this.connections=[],this.signaling=t,this.listenSignaling(),e.forEach((async e=>{await this.join(e)}))}async sendOffer(e){const{signaling:t}=this,n=await e.createOffer();try{e.setLocalDescription(n),t.send({type:"offer",data:n},e.peer),p.info("发送offer",n)}catch(r){p.info("发送offer失败",r)}}listenSignaling(){const{signaling:e,connections:t,join:n}=this;e.addEventListener("message",(async({detail:{from:r,content:{type:o,data:i}}})=>{let s=t.find((e=>e.peer===r));switch(s||(p.info("未找到匹配的 connection, 重新创建"),s=await n.call(this,r),this.dispatchEvent(new CustomEvent("new",{detail:s}))),o){case"offer":p.info("收到offer",i);try{await s.setRemoteDescription(i);const t=await s.createAnswer();e.send({type:"answer",data:t},r),p.info("发送answer",t),s.setLocalDescription(t)}catch(a){p.info("收到 offer 后执行异常",a)}break;case"answer":p.info("收到 answer",i);try{s.setRemoteDescription(i)}catch(c){p.info("setRemoteDescription 失败",c)}break;case"candidate":p.info("收到 candidate",i),s.addIceCandidate(i);break}}))}listenConnection(e){const{signaling:t}=this;e.addEventListener("icecandidate",(({candidate:n})=>{n&&t.send({type:"candidate",data:n},e.peer)})),e.addEventListener("negotiationneeded",(async()=>{p.info("negotiationneeded"),this.sendOffer(e)})),e.addEventListener("connectionstatechange",(async()=>{p.info(`与用户${e.peer}连接状态：${e.connectionState}`)}))}async join(e){const{connections:t}=this,n=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]});return p.info("创建 RTCPeerConnection",e),this.listenConnection(n),n.peer=e,t.push(n),n}}const m=e=>Object.prototype.toString.call(e).slice(8,-1),v=async e=>{let t=e;"Blob"===m(e)&&(t=await e.text());let n={};try{n=JSON.parse(t)}catch(r){console.error(r)}return n},y="signaling",w=async e=>{const{data:t}=e,n=await v(t),{cmd:r,from:o,data:i={}}=n,{type:s,content:a}=i;if("send"===r&&s===y)return{content:a,from:o}};class b extends EventTarget{constructor(e){super(),this.socket=e;const t=1,n=3;if(e.readyState===t){const e=new CustomEvent("open");this.dispatchEvent(e)}if(e.readyState===n){const e=new CustomEvent("close");this.dispatchEvent(e)}this.socket.addEventListener("open",(e=>{const t=new CustomEvent("open",e);this.dispatchEvent(t)})),this.socket.addEventListener("close",(e=>{const t=new CustomEvent("close",e);this.dispatchEvent(t)})),this.socket.addEventListener("message",(async e=>{const t=await w(e);if(!t)return;const n=new CustomEvent("message",{detail:t});this.dispatchEvent(n)}))}send(e,t){this.socket.send(JSON.stringify({cmd:"send",data:{type:y,content:e},to:t?[t]:[]}))}}n(1439),n(7585),n(5315);const E=16,C=4,S=(e=16)=>Array.from(new Array(e),(()=>Math.floor(256*Math.random()))).join(),k=e=>{try{return(new TextEncoder).encode(JSON.stringify(e))}catch{}},L=e=>{try{return JSON.parse((new TextDecoder).decode(e))}catch{}},x=e=>{const t={};return e.headers.forEach(((e,n)=>{t[n]=e})),t},O=(e,t)=>{const n=new Uint8Array(t);for(let r=0;r<t;r++){const o=8*(t-r-1),i=255<<o;n[r]=(e&i)>>>o}return n},_=e=>{let t=0;for(let n=0;n<e.length;n++){const r=8*(e.length-n-1);t|=e[n]<<r}return t},A=async(e,t)=>{const n=await e.arrayBuffer(),r=new Uint8Array(t.split(",")),o=k(x(e));if(o.byteLength>2**(8*C))return;const i=O(o.byteLength,4),s=new Uint8Array(n),a=new Uint8Array(E+C+o.byteLength+n.byteLength);return a.set(r),a.set(i,E),a.set(o,E+C),a.set(s,E+C+o.byteLength),a.buffer},T=async e=>{const t=new Uint8Array(e),n=t.slice(0,E).toString(),r=_(t.slice(E,E+C)),o=L(t.slice(E+C,E+C+r)),i=t.slice(E+C+r);return{id:n,headers:o,body:i}},j=new f("【fetchRTC】"),R={fetch:"fetch",peers:"peers"};class P{constructor(e,t,n={}){this.options={...P.defaultOptions,...n},this.retryAttempts=0,this.promiseResolves={};const{socketBaseURL:r}=this.options,o=new WebSocket(`${r}?room=${t}&peer=${e}`);this.signaling=new b(o),o.addEventListener("open",(()=>{o.addEventListener("message",(({data:t})=>{const{data:n,cmd:r}=JSON.parse(t);if(r===R.peers){const t=n.filter((t=>t!==e));this.multiRTCPeerConnection=new g(t,this.signaling),this.multiRTCPeerConnection.addEventListener("new",(({detail:e})=>{this.listenChannel(e)})),this.multiRTCPeerConnection.connections.forEach((e=>{this.listenChannel(e),this.mountChannel(e)}))}})),o.send('{"cmd":"peers"}')}))}broadcast(e,t){this.multiRTCPeerConnection?.connections.forEach((n=>{const r=()=>{let r;try{r=JSON.stringify({cmd:e,data:t})}catch{j.error("message 转换异常",e,t)}n.channel?.send(r)};"open"===n.channel?.readyState?r():n.channel.onopen=()=>{r()}}))}mountChannel(e,t){return e.channel=t||e.createDataChannel(""),e.channel.addEventListener("error",(({error:t})=>{const{channelMaxRetries:n}=this.options;t.errorDetail||this.retryAttempts>n||(this.retryAttempts++,this.mountChannel(e))})),e.channel.addEventListener("message",(async({data:t})=>{if(this.retryAttempts=0,"string"===typeof t){let n,r;try{let e=JSON.parse(t);n=e.cmd,r=e.data}catch{j.error("message 解析异常",t)}if(n===R.fetch){const{url:t,id:n}=r;let o=await caches.match(t,{ignoreSearch:!0});if(!o)return;const i=await A(o,n);e.channel?.send(i)}}if(t instanceof ArrayBuffer){const{id:e,headers:n,body:r}=await T(t);this.promiseResolves[e]?.call(this,{headers:n,body:r})}})),e.channel}listenChannel(e){e.addEventListener("datachannel",(({channel:t})=>{this.mountChannel(e,t)}))}listen(e){e.addEventListener("message",(({data:e})=>{const{url:t,id:n}=e;j.info("发起",e),this.fetch(t).then((({headers:e,body:t})=>{j.info("响应",{headers:e,body:t}),navigator.serviceWorker.controller.postMessage({id:n,headers:e,body:t})}))}))}fetch(e){return new Promise((t=>{const n=S();this.broadcast(R.fetch,{url:e,id:n}),this.promiseResolves[n]=t}))}}(0,u.Z)(P,"defaultOptions",{channelMaxRetries:3,socketBaseURL:"wss://service-h4z7zdeo-1258344701.gz.apigw.tencentcs.com"});var N=P;const W=new URLSearchParams(location.search).get("peer"),D=new N(W,"ola"),U=()=>{"serviceWorker"in navigator&&window.addEventListener("load",(()=>{D.listen(navigator.serviceWorker),navigator.serviceWorker.register("/sw.js").then((e=>{console.log("SW registered: ",e)})).catch((e=>{console.log("SW registration failed: ",e)}))}))};U(),r.ZP.config.productionTip=!1,new r.ZP({render:e=>e(d)}).$mount("#app")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}n.m=e,function(){var e=[];n.O=function(t,r,o,i){if(!r){var s=1/0;for(d=0;d<e.length;d++){r=e[d][0],o=e[d][1],i=e[d][2];for(var a=!0,c=0;c<r.length;c++)(!1&i||s>=i)&&Object.keys(n.O).every((function(e){return n.O[e](r[c])}))?r.splice(c--,1):(a=!1,i<s&&(s=i));if(a){e.splice(d--,1);var l=o();void 0!==l&&(t=l)}}return t}i=i||0;for(var d=e.length;d>0&&e[d-1][2]>i;d--)e[d]=e[d-1];e[d]=[r,o,i]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}}(),function(){n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce((function(t,r){return n.f[r](e,t),t}),[]))}}(),function(){n.u=function(e){return"js/"+e+".93353183.js"}}(),function(){n.miniCssF=function(e){return"css/"+e+".d43f2a10.css"}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={},t="rtc-workbox:";n.l=function(r,o,i,s){if(e[r])e[r].push(o);else{var a,c;if(void 0!==i)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var u=l[d];if(u.getAttribute("src")==r||u.getAttribute("data-webpack")==t+i){a=u;break}}a||(c=!0,a=document.createElement("script"),a.charset="utf-8",a.timeout=120,n.nc&&a.setAttribute("nonce",n.nc),a.setAttribute("data-webpack",t+i),a.src=r),e[r]=[o];var h=function(t,n){a.onerror=a.onload=null,clearTimeout(f);var o=e[r];if(delete e[r],a.parentNode&&a.parentNode.removeChild(a),o&&o.forEach((function(e){return e(n)})),t)return t(n)},f=setTimeout(h.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=h.bind(null,a.onerror),a.onload=h.bind(null,a.onload),c&&document.head.appendChild(a)}}}(),function(){n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){n.p="/"}(),function(){if("undefined"!==typeof document){var e=function(e,t,n,r,o){var i=document.createElement("link");i.rel="stylesheet",i.type="text/css";var s=function(n){if(i.onerror=i.onload=null,"load"===n.type)r();else{var s=n&&("load"===n.type?"missing":n.type),a=n&&n.target&&n.target.href||t,c=new Error("Loading CSS chunk "+e+" failed.\n("+a+")");c.code="CSS_CHUNK_LOAD_FAILED",c.type=s,c.request=a,i.parentNode&&i.parentNode.removeChild(i),o(c)}};return i.onerror=i.onload=s,i.href=t,n?n.parentNode.insertBefore(i,n.nextSibling):document.head.appendChild(i),i},t=function(e,t){for(var n=document.getElementsByTagName("link"),r=0;r<n.length;r++){var o=n[r],i=o.getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(i===e||i===t))return o}var s=document.getElementsByTagName("style");for(r=0;r<s.length;r++){o=s[r],i=o.getAttribute("data-href");if(i===e||i===t)return o}},r=function(r){return new Promise((function(o,i){var s=n.miniCssF(r),a=n.p+s;if(t(s,a))return o();e(r,a,null,o,i)}))},o={143:0};n.f.miniCss=function(e,t){var n={173:1};o[e]?t.push(o[e]):0!==o[e]&&n[e]&&t.push(o[e]=r(e).then((function(){o[e]=0}),(function(t){throw delete o[e],t})))}}}(),function(){var e={143:0};n.f.j=function(t,r){var o=n.o(e,t)?e[t]:void 0;if(0!==o)if(o)r.push(o[2]);else{var i=new Promise((function(n,r){o=e[t]=[n,r]}));r.push(o[2]=i);var s=n.p+n.u(t),a=new Error,c=function(r){if(n.o(e,t)&&(o=e[t],0!==o&&(e[t]=void 0),o)){var i=r&&("load"===r.type?"missing":r.type),s=r&&r.target&&r.target.src;a.message="Loading chunk "+t+" failed.\n("+i+": "+s+")",a.name="ChunkLoadError",a.type=i,a.request=s,o[1](a)}};n.l(s,c,"chunk-"+t,t)}},n.O.j=function(t){return 0===e[t]};var t=function(t,r){var o,i,s=r[0],a=r[1],c=r[2],l=0;if(s.some((function(t){return 0!==e[t]}))){for(o in a)n.o(a,o)&&(n.m[o]=a[o]);if(c)var d=c(n)}for(t&&t(r);l<s.length;l++)i=s[l],n.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return n.O(d)},r=self["webpackChunkrtc_workbox"]=self["webpackChunkrtc_workbox"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))}();var r=n.O(void 0,[998],(function(){return n(4372)}));r=n.O(r)})();
//# sourceMappingURL=app.9ddc82f8.js.map